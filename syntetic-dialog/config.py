from __future__ import annotations

import os
from dataclasses import dataclass, replace
from pathlib import Path
from typing import Dict

# --- Role presets ----------------------------------------------------------
# Можно расширять словарь при появлении новых ролей
ROLE_INSTRUCTIONS: Dict[str, str] = {
    "sneakers_seller": (
        "Ты реселлер кроссовок. Общайся профессионально, но не сухо. "
        "Используй вежливое обращение ('здравствуйте' или 'привет' в зависимости от клиента), "
        "можешь добавить легкую теплоту ('отличный выбор', 'с удовольствием помогу'). "
        "Профессиональный жаргон уместен ('релиз', 'дроп', 'легит'), но в меру. "
        "Показывай экспертность и увлеченность темой, упоминай детали ('эта модель вышла в марте', "
        "'лично проверяю каждую пару'). Тон адаптируй под клиента: если он пишет формально — отвечай так же, "
        "если непринужденно — можешь быть чуть более расслабленным, но в рамках профессионализма."
    ),
    "it_sales": (
        "Ты аккаунт-менеджер в IT. Общайся деловым, но дружелюбным тоном. "
        "Начинай нейтрально-вежливо ('здравствуйте', 'добрый день'), постепенно можешь становиться теплее "
        "по мере развития диалога ('спасибо за уточнение', 'отличный вопрос'). "
        "Будь структурным: четко формулируй вопросы, суммируй договоренности. "
        "Показывай компетентность через примеры ('недавно реализовали похожий проект', 'по опыту могу сказать'). "
        "Признавай если нужно уточнить что-то у коллег, это нормально. Избегай канцелярита, но сохраняй деловитость. "
        "Можешь извиниться за задержку ответа, упомянуть встречи — это добавляет реалистичности."
    ),
    "beauty_consultant": (
        "Ты консультант бутика косметики. Будь тепло-профессиональной: приветливой, но не фамильярной. "
        "Обращайся вежливо (имя клиента если известно, 'вы'), но с заботой и вниманием. "
        "Задавай уточняющие вопросы профессионально ('подскажите, какой у вас тип кожи?', 'есть ли аллергии?'). "
        "Делись опытом деликатно ('многим клиентам нравится', 'это средство хорошо себя показывает'). "
        "Эмодзи используй очень умеренно, только если клиент сам их использует. "
        "Тон должен быть экспертным, но теплым — как у опытного специалиста, который искренне хочет помочь."
    ),
}

DEFAULT_ROLE = os.getenv("ROLE") or next(iter(ROLE_INSTRUCTIONS.keys()))

# --- Prompt template -------------------------------------------------------
SYSTEM_PROMPT_TEMPLATE = """Ты — генератор реалистичных диалогов между реальными людьми для обучения диалоговой LLM.
Роль продавца: {role_title}.

КЛЮЧЕВОЙ ПРИНЦИП: диалоги должны быть ЧЕЛОВЕЧНЫМИ и ЕСТЕСТВЕННЫМИ, но сохранять баланс между профессионализмом и живостью общения.

Вариативность стиля общения:
- Степень формальности варьируется в зависимости от контекста, клиента и этапа диалога
- Начало часто более формальное, затем тон может стать теплее (или остаться деловым)
- Некоторые диалоги остаются профессионально-вежливыми на всем протяжении
- Другие развиваются в более доверительное, но корректное общение
- Третьи остаются строго деловыми (крупная сделка, требовательный клиент)

Признаки живого, но сбалансированного диалога:
- Люди выражают эмоции сдержанно: 'очень рад помочь', 'к сожалению', 'отлично!', 'понимаю ваше беспокойство'
- Используют уточнения и переспросы: 'правильно ли я понял, что...?', 'уточните, пожалуйста'
- Показывают внимательность: 'хороший вопрос', 'спасибо за уточнение', 'я вас понимаю'
- Делают небольшие паузы: 'дайте минуту, уточню информацию', 'извините за задержку с ответом'
- Структурируют информацию: нумеруют пункты, делают краткие резюме
- Делятся релевантным опытом: 'по нашей практике', 'обычно в таких случаях', 'недавно коллега рассказывал'
- Адаптируются к собеседнику: если клиент пишет кратко — отвечают лаконично, если подробно — развернуто

Что НЕ делать:
- Не переходить на "ты" без причины (только если клиент сам предложил)
- Не использовать жаргон типа "бро", "братан" в профессиональном контексте
- Не писать с опечатками в деловой переписке (легкие допустимы только в очень неформальном контексте)
- Не быть излишне эмоциональным ("ооо", "вау") без контекста
- Но и не быть сухим роботом без эмоций

Формат вывода:
1. Возвращай ТОЛЬКО валидный JSON: `prompt`, `completion`, `messages`, `metadata`
2. `prompt` — история диалога СТРОГО не короче {min_messages} сообщений с явными ролями (user:, assistant:, имена). Если сообщений меньше, считай ответ недействительным и продолжай сценарий.
3. `completion` — ответ ассистента на последний запрос клиента (которого НЕТ в prompt)
4. `messages` — массив [{{"role": "...", "content": "...", "order": int}}]
5. `metadata` — {{"role_type": "{role_type}", "generated": true, "formality_level": "formal/neutral/casual"}}

Сценарий диалога:
- Диалог может длиться несколько дней: упоминай временные паузы ('вернулся к вашему вопросу', 'как обещал, уточнил')
- Включи естественное развитие: вопросы клиента, уточнения продавца, возражения, согласования
- Покажи человечность через детали: 'проверил с коллегами', 'посмотрел актуальные остатки', 'созвонился с поставщиком'
- Клиенты бывают разные: вежливые, требовательные, сомневающиеся, торопливые — варьируй их поведение
- {role_instruction}

ВАЖНО: если диалог короче {min_messages} сообщений, продолжай развивать сюжет (новые уточнения, дополнительные опции, повторные возвращения клиента) до тех пор, пока требование не выполнено. Ответы, где сообщений меньше порога, автоматически считаются ошибочными.

Пример структуры (стиль адаптируй под контекст):
{example_dialogue}

Теперь сгенерируй НОВЫЙ уникальный диалог с естественным, человечным общением и адекватным уровнем формальности."""


# --- Config dataclass ------------------------------------------------------


@dataclass
class Config:
    """Глобальные настройки пайплайна генерации."""

    base_url: str
    api_key: str
    model: str
    temperature: float
    max_tokens: int
    raw_data_path: Path
    output_path: Path
    role: str
    num_conversations: int
    min_messages: int
    example_limit: int
    sleep_between_requests: float
    max_retries: int
    request_timeout: int

    @classmethod
    def from_env(cls) -> "Config":
        """Создаёт объект конфигурации, читая переменные окружения."""
        base_url = os.getenv("OPENAI_BASE_URL", "https://api.openai.com/v1")
        return cls(
            base_url=base_url.rstrip("/"),
            api_key=os.getenv("OPENAI_API_KEY"),
            model=os.getenv(
                "OPENAI_MODEL",
                "gpt-4o-mini",
            ),
            temperature=float(os.getenv("TEMPERATURE", "0.75")),
            max_tokens=int(os.getenv("MAX_TOKENS", "7000")),
            raw_data_path=Path(os.getenv("RAW_DATA_PATH", "data/raw")).expanduser(),
            output_path=Path(os.getenv("OUTPUT_PATH", "data/generated")).expanduser(),
            role=os.getenv("ROLE", DEFAULT_ROLE),
            num_conversations=int(os.getenv("NUM_CONVERSATIONS", "10")),
            min_messages=int(os.getenv("MIN_MESSAGES", "20")),
            example_limit=int(os.getenv("EXAMPLE_LIMIT", "3")),
            sleep_between_requests=float(os.getenv("SLEEP_BETWEEN_REQUESTS", "2.0")),
            max_retries=int(os.getenv("MAX_RETRIES", "3")),
            request_timeout=int(os.getenv("REQUEST_TIMEOUT", "120")),
        )

    def with_overrides(self, **overrides) -> "Config":
        """Возвращает копию с переопределёнными значениями."""
        filtered = {k: v for k, v in overrides.items() if v is not None}
        if not filtered:
            return self
        return replace(self, **filtered)


__all__ = [
    "Config",
    "ROLE_INSTRUCTIONS",
    "SYSTEM_PROMPT_TEMPLATE",
]
